<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
        <html lang='en' xml:lang='en' xmlns='http://www.w3.org/1999/xhtml'>
          <head>
            <title>mochiweb - C0 code coverage information</title>
            <style type='text/css'>body { background-color: rgb(240, 240, 245); }</style>
            <style type='text/css'>span.marked0 {
     background-color: rgb(185, 210, 200);
     display: block;
    }
    span.marked { display: block; background-color: #ffffff; }
    span.highlight { display: block; background-color: #fff9d7; }
    span.covered { display: block; background-color: #f7f7f7 ; }
    span.uncovered { display: block; background-color: #ffebe8 ; }
    span.overview {
     border-bottom: 1px solid #E2E6EF; 
    }
    div.overview {
     border-bottom: 1px solid #E2E6EF; 
    }
    body {
     font-family: verdana, arial, helvetica;
    }
    div.footer {
     font-size: 68%;
     margin-top: 1.5em;
    }
    h1, h2, h3, h4, h5, h6 {
     margin-bottom: 0.5em;
    }
    h5 {
     margin-top: 0.5em;
    }
    .hidden {
     display: none;
    }
    div.separator {
     height: 10px;
    }
    table.percent_graph {
     height: 12px;
     border: 1px solid #E2E6EF; 
     empty-cells: show;
    }
    table.percent_graph td.covered {
     height: 10px;
     background: #00f000;
    }
    table.percent_graph td.uncovered {
     height: 10px;
     background: #e00000;
    }
    table.percent_graph td.NA {
     height: 10px;
     background: #eaeaea;
    }
    table.report {
     border-collapse: collapse;
     width: 100%;
    }
    table.report td.heading {
     background: #dcecff;
     border: 1px solid #E2E6EF; 
     font-weight: bold;
     text-align: center;
    }
    table.report td.heading:hover {
     background: #c0ffc0;
    }
    table.report td.text {
     border: 1px solid #E2E6EF; 
    }
    table.report td.value {
     text-align: right;
     border: 1px solid #E2E6EF; 
    }
    table.report tr.light {
     background-color: rgb(240, 240, 245);
    }
    table.report tr.dark {
     background-color: rgb(230, 230, 235);
    }
    </style>
          </head>
          <body>
            <h3>C0 code coverage information</h3>
            <p>Generated on 2009-02-25 00:22:45 with <a href='http://github.com/ngerakines/etap'>etap 0.3.3</a>.
            </p>            
        <table class='report'>
          <thead>
            <tr>
              <td class='heading'>Name</td>
              <td class='heading'>Total lines</td>
              <td class='heading'>Lines of code</td>
              <td class='heading'>Total coverage</td>
              <td class='heading'>Code coverage</td>
            </tr>
          </thead>
          <tbody>
            <tr class='light'>

              <td>
                <a href='mochiweb_report.html'>mochiweb</a>
              </td>
              <td class='value'>
                <tt>??</tt>
              </td>
              <td class='value'>
                <tt>??</tt>
              </td>
              <td class='value'>
                <tt>??</tt>
              </td>
              <td>
                <table cellspacing='0' cellpadding='0' align='right'>
                  <tr>
                    <td><tt>0%</tt>&nbsp;</td><td>
                      <table cellspacing='0' class='percent_graph' cellpadding='0' width='100'>
                      <tr><td class='covered' width='0' /><td class='uncovered' width='100' /></tr>
                      </table>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </tbody>
        </table><pre><span class="marked"><a name="line1"></a>....1 %% @author Bob Ippolito <bob@mochimedia.com>
</span><span class="marked"><a name="line2"></a>....2 %% @author Nick Gerakines <nick@gerakines.net>
</span><span class="marked"><a name="line3"></a>....3 %% @copyright 2007 Mochi Media, Inc.
</span><span class="marked"><a name="line4"></a>....4 %% @copyright 2009 Nick Gerakines
</span><span class="highlight"><a name="line5"></a>....5 %% @todo Find a better model to use instead of gen_server.
</span><span class="marked"><a name="line6"></a>....6 -module(mochiweb).
</span><span class="marked"><a name="line7"></a>....7 
</span><span class="marked"><a name="line8"></a>....8 -behaviour(gen_server).
</span><span class="marked"><a name="line9"></a>....9 
</span><span class="marked"><a name="line10"></a>...10 -export([start/1, stop/1]).
</span><span class="marked"><a name="line11"></a>...11 -export([init/1, handle_call/3, handle_cast/2, terminate/2, code_change/3, handle_info/2]).
</span><span class="marked"><a name="line12"></a>...12 -export([get/2]).
</span><span class="marked"><a name="line13"></a>...13 -export([acceptor_loop/1]).
</span><span class="marked"><a name="line14"></a>...14 -record(mochiweb_socket_server, {port, loop, name = undefined, max = 2048, ip = any, listen = null, acceptor = null, backlog = 30}).
</span><span class="marked"><a name="line15"></a>...15 
</span><span class="marked"><a name="line16"></a>...16 start(State = #mochiweb_socket_server{}) ->
</span><span class="uncovered"><a name="line17"></a>...17     start_server(State);
</span><span class="marked"><a name="line18"></a>...18 start(Options) ->
</span><span class="uncovered"><a name="line19"></a>...19     start(parse_options(Options)).
</span><span class="marked"><a name="line20"></a>...20 
</span><span class="marked"><a name="line21"></a>...21 stop(Name) when is_atom(Name) ->
</span><span class="uncovered"><a name="line22"></a>...22     gen_server:cast(Name, stop);
</span><span class="marked"><a name="line23"></a>...23 stop(Pid) when is_pid(Pid) ->
</span><span class="uncovered"><a name="line24"></a>...24     gen_server:cast(Pid, stop);
</span><span class="marked"><a name="line25"></a>...25 stop({local, Name}) ->
</span><span class="uncovered"><a name="line26"></a>...26     stop(Name);
</span><span class="marked"><a name="line27"></a>...27 stop({global, Name}) ->
</span><span class="uncovered"><a name="line28"></a>...28     stop(Name);
</span><span class="marked"><a name="line29"></a>...29 stop(Options) ->
</span><span class="uncovered"><a name="line30"></a>...30     State = parse_options(Options),
</span><span class="uncovered"><a name="line31"></a>...31     stop(State#mochiweb_socket_server.name).
</span><span class="marked"><a name="line32"></a>...32 
</span><span class="marked"><a name="line33"></a>...33 get(Name, Property) ->
</span><span class="uncovered"><a name="line34"></a>...34     gen_server:call(Name, {get, Property}).
</span><span class="marked"><a name="line35"></a>...35 
</span><span class="marked"><a name="line36"></a>...36 %% Internal API
</span><span class="marked"><a name="line37"></a>...37 
</span><span class="marked"><a name="line38"></a>...38 parse_options(Options) ->
</span><span class="uncovered"><a name="line39"></a>...39     parse_options(Options, #mochiweb_socket_server{}).
</span><span class="marked"><a name="line40"></a>...40 
</span><span class="marked"><a name="line41"></a>...41 parse_options([], State) ->
</span><span class="uncovered"><a name="line42"></a>...42     State;
</span><span class="marked"><a name="line43"></a>...43 parse_options([{name, L} | Rest], State) when is_list(L) ->
</span><span class="uncovered"><a name="line44"></a>...44     parse_options(Rest, State#mochiweb_socket_server{name = {local, list_to_atom(L)}});
</span><span class="marked"><a name="line45"></a>...45 parse_options([{name, A} | Rest], State) when is_atom(A) ->
</span><span class="uncovered"><a name="line46"></a>...46     parse_options(Rest, State#mochiweb_socket_server{name = {local, A}});
</span><span class="marked"><a name="line47"></a>...47 parse_options([{name, Name} | Rest], State) ->
</span><span class="uncovered"><a name="line48"></a>...48     parse_options(Rest, State#mochiweb_socket_server{name = Name});
</span><span class="marked"><a name="line49"></a>...49 parse_options([{port, L} | Rest], State) when is_list(L) ->
</span><span class="uncovered"><a name="line50"></a>...50     parse_options(Rest, State#mochiweb_socket_server{port = list_to_integer(L)});
</span><span class="marked"><a name="line51"></a>...51 parse_options([{port, Port} | Rest], State) ->
</span><span class="uncovered"><a name="line52"></a>...52     parse_options(Rest, State#mochiweb_socket_server{port = Port});
</span><span class="marked"><a name="line53"></a>...53 parse_options([{ip, any} | Rest], State) ->
</span><span class="uncovered"><a name="line54"></a>...54     parse_options(Rest, State#mochiweb_socket_server{ip = any});
</span><span class="marked"><a name="line55"></a>...55 parse_options([{ip, Ip} | Rest], State) when is_tuple(Ip) ->
</span><span class="uncovered"><a name="line56"></a>...56     parse_options(Rest, State#mochiweb_socket_server{ip = Ip});
</span><span class="marked"><a name="line57"></a>...57 parse_options([{ip, Ip} | Rest], State) when is_list(Ip) ->
</span><span class="uncovered"><a name="line58"></a>...58     {ok, IpTuple} = inet_parse:address(Ip),
</span><span class="uncovered"><a name="line59"></a>...59     parse_options(Rest, State#mochiweb_socket_server{ip = IpTuple});
</span><span class="marked"><a name="line60"></a>...60 parse_options([{loop, Loop} | Rest], State) ->
</span><span class="uncovered"><a name="line61"></a>...61     parse_options(Rest, State#mochiweb_socket_server{loop = Loop});
</span><span class="marked"><a name="line62"></a>...62 parse_options([{backlog, Backlog} | Rest], State) ->
</span><span class="uncovered"><a name="line63"></a>...63     parse_options(Rest, State#mochiweb_socket_server{backlog = Backlog});
</span><span class="marked"><a name="line64"></a>...64 parse_options([{max, Max} | Rest], State) when is_integer(Max) ->
</span><span class="uncovered"><a name="line65"></a>...65     parse_options(Rest, State#mochiweb_socket_server{max = Max});
</span><span class="marked"><a name="line66"></a>...66 parse_options([{max, Max} | Rest], State) when is_list(Max) ->
</span><span class="uncovered"><a name="line67"></a>...67     parse_options(Rest, State#mochiweb_socket_server{max = list_to_integer(Max)}).
</span><span class="marked"><a name="line68"></a>...68 
</span><span class="marked"><a name="line69"></a>...69 start_server(State = #mochiweb_socket_server{name = undefined}) ->
</span><span class="uncovered"><a name="line70"></a>...70     gen_server:start_link(?MODULE, State, []);
</span><span class="marked"><a name="line71"></a>...71 start_server(State = #mochiweb_socket_server{name = Name}) ->
</span><span class="uncovered"><a name="line72"></a>...72     gen_server:start_link(Name, ?MODULE, State, []).
</span><span class="marked"><a name="line73"></a>...73 
</span><span class="marked"><a name="line74"></a>...74 ipv6_supported() ->
</span><span class="uncovered"><a name="line75"></a>...75     try inet:getaddr("localhost", inet6) of
</span><span class="uncovered"><a name="line76"></a>...76         {ok, _} -> true;
</span><span class="uncovered"><a name="line77"></a>...77         _ -> false
</span><span class="marked"><a name="line78"></a>...78     catch
</span><span class="uncovered"><a name="line79"></a>...79         _:_ -> false
</span><span class="marked"><a name="line80"></a>...80     end.
</span><span class="marked"><a name="line81"></a>...81 
</span><span class="marked"><a name="line82"></a>...82 init(State = #mochiweb_socket_server{ip = Ip, port = Port, backlog = Backlog}) ->
</span><span class="uncovered"><a name="line83"></a>...83     process_flag(trap_exit, true),
</span><span class="uncovered"><a name="line84"></a>...84     BaseOpts = [
</span><span class="marked"><a name="line85"></a>...85         binary, 
</span><span class="marked"><a name="line86"></a>...86         {reuseaddr, true},
</span><span class="marked"><a name="line87"></a>...87         {packet, 0},
</span><span class="marked"><a name="line88"></a>...88         {backlog, Backlog},
</span><span class="marked"><a name="line89"></a>...89         {recbuf, 8192},
</span><span class="marked"><a name="line90"></a>...90         {active, false},
</span><span class="marked"><a name="line91"></a>...91         {nodelay, true}
</span><span class="marked"><a name="line92"></a>...92     ],
</span><span class="uncovered"><a name="line93"></a>...93     Opts = case Ip of
</span><span class="marked"><a name="line94"></a>...94         any ->
</span><span class="uncovered"><a name="line95"></a>...95             case ipv6_supported() of % IPv4, and IPv6 if supported
</span><span class="uncovered"><a name="line96"></a>...96                 true -> [inet, inet6 | BaseOpts];
</span><span class="uncovered"><a name="line97"></a>...97                 _ -> BaseOpts
</span><span class="marked"><a name="line98"></a>...98             end;
</span><span class="marked"><a name="line99"></a>...99         {_, _, _, _} -> % IPv4
</span><span class="uncovered"><a name="line100"></a>..100             [inet, {ip, Ip} | BaseOpts];
</span><span class="marked"><a name="line101"></a>..101         {_, _, _, _, _, _, _, _} -> % IPv6
</span><span class="uncovered"><a name="line102"></a>..102             [inet6, {ip, Ip} | BaseOpts]
</span><span class="marked"><a name="line103"></a>..103     end,
</span><span class="uncovered"><a name="line104"></a>..104     case gen_tcp_listen(Port, Opts, State) of
</span><span class="marked"><a name="line105"></a>..105         {stop, eacces} ->
</span><span class="uncovered"><a name="line106"></a>..106             case Port < 1024 of 
</span><span class="marked"><a name="line107"></a>..107                 true ->
</span><span class="uncovered"><a name="line108"></a>..108                     case fdsrv:start() of
</span><span class="marked"><a name="line109"></a>..109                         {ok, _} ->
</span><span class="uncovered"><a name="line110"></a>..110                             case fdsrv:bind_socket(tcp, Port) of
</span><span class="marked"><a name="line111"></a>..111                                 {ok, Fd} ->
</span><span class="uncovered"><a name="line112"></a>..112                                     gen_tcp_listen(Port, [{fd, Fd} | Opts], State);
</span><span class="marked"><a name="line113"></a>..113                                 _ ->
</span><span class="uncovered"><a name="line114"></a>..114                                     {stop, fdsrv_bind_failed}
</span><span class="marked"><a name="line115"></a>..115                             end;
</span><span class="marked"><a name="line116"></a>..116                         _ ->
</span><span class="uncovered"><a name="line117"></a>..117                             {stop, fdsrv_start_failed}
</span><span class="marked"><a name="line118"></a>..118                     end;
</span><span class="marked"><a name="line119"></a>..119                 false ->
</span><span class="uncovered"><a name="line120"></a>..120                     {stop, eacces}
</span><span class="marked"><a name="line121"></a>..121             end;
</span><span class="marked"><a name="line122"></a>..122         Other ->
</span><span class="uncovered"><a name="line123"></a>..123             Other
</span><span class="marked"><a name="line124"></a>..124     end.
</span><span class="marked"><a name="line125"></a>..125 
</span><span class="marked"><a name="line126"></a>..126 gen_tcp_listen(Port, Opts, State) ->
</span><span class="uncovered"><a name="line127"></a>..127     case gen_tcp:listen(Port, Opts) of
</span><span class="marked"><a name="line128"></a>..128         {ok, Listen} ->
</span><span class="uncovered"><a name="line129"></a>..129             {ok, ListenPort} = inet:port(Listen),
</span><span class="uncovered"><a name="line130"></a>..130             {ok, new_acceptor(State#mochiweb_socket_server{listen = Listen, port = ListenPort})};
</span><span class="marked"><a name="line131"></a>..131         {error, Reason} ->
</span><span class="uncovered"><a name="line132"></a>..132             {stop, Reason}
</span><span class="marked"><a name="line133"></a>..133     end.
</span><span class="marked"><a name="line134"></a>..134 
</span><span class="marked"><a name="line135"></a>..135 new_acceptor(State=#mochiweb_socket_server{max=0}) ->
</span><span class="uncovered"><a name="line136"></a>..136     error_logger:error_report([
</span><span class="marked"><a name="line137"></a>..137         {application, mochiweb},
</span><span class="marked"><a name="line138"></a>..138         "Accept failed error",
</span><span class="marked"><a name="line139"></a>..139         "Not accepting new connections"
</span><span class="marked"><a name="line140"></a>..140     ]),
</span><span class="uncovered"><a name="line141"></a>..141     State#mochiweb_socket_server{acceptor=null};
</span><span class="marked"><a name="line142"></a>..142 new_acceptor(State = #mochiweb_socket_server{listen = Listen, loop = Loop}) ->
</span><span class="uncovered"><a name="line143"></a>..143     Pid = proc_lib:spawn_link(?MODULE, acceptor_loop, [{self(), Listen, Loop}]),
</span><span class="uncovered"><a name="line144"></a>..144     State#mochiweb_socket_server{acceptor=Pid}.
</span><span class="marked"><a name="line145"></a>..145 
</span><span class="marked"><a name="line146"></a>..146 call_loop({M, F}, Socket) ->
</span><span class="uncovered"><a name="line147"></a>..147     M:F(Socket);
</span><span class="marked"><a name="line148"></a>..148 call_loop(Loop, Socket) ->
</span><span class="uncovered"><a name="line149"></a>..149     Loop(Socket).
</span><span class="marked"><a name="line150"></a>..150 
</span><span class="marked"><a name="line151"></a>..151 acceptor_loop({Server, Listen, Loop}) ->
</span><span class="uncovered"><a name="line152"></a>..152     case catch gen_tcp:accept(Listen) of
</span><span class="marked"><a name="line153"></a>..153         {ok, Socket} ->
</span><span class="uncovered"><a name="line154"></a>..154             gen_server:cast(Server, {accepted, self()}),
</span><span class="uncovered"><a name="line155"></a>..155             call_loop(Loop, Socket);
</span><span class="marked"><a name="line156"></a>..156         {error, closed} ->
</span><span class="uncovered"><a name="line157"></a>..157             exit({error, closed});
</span><span class="marked"><a name="line158"></a>..158         Other ->
</span><span class="uncovered"><a name="line159"></a>..159             error_logger:error_report([
</span><span class="marked"><a name="line160"></a>..160                 {application, mochiweb},
</span><span class="marked"><a name="line161"></a>..161                 "Accept failed error",
</span><span class="marked"><a name="line162"></a>..162                 lists:flatten(io_lib:format("~p", [Other]))
</span><span class="marked"><a name="line163"></a>..163             ]),
</span><span class="uncovered"><a name="line164"></a>..164             exit({error, accept_failed})
</span><span class="marked"><a name="line165"></a>..165     end.
</span><span class="marked"><a name="line166"></a>..166             
</span><span class="marked"><a name="line167"></a>..167 
</span><span class="marked"><a name="line168"></a>..168 do_get(port, #mochiweb_socket_server{port=Port}) ->
</span><span class="uncovered"><a name="line169"></a>..169     Port.
</span><span class="marked"><a name="line170"></a>..170     
</span><span class="marked"><a name="line171"></a>..171 handle_call({get, Property}, _From, State) ->
</span><span class="uncovered"><a name="line172"></a>..172     Res = do_get(Property, State),
</span><span class="uncovered"><a name="line173"></a>..173     {reply, Res, State};
</span><span class="marked"><a name="line174"></a>..174 handle_call(_Message, _From, State) ->
</span><span class="uncovered"><a name="line175"></a>..175     Res = error,
</span><span class="uncovered"><a name="line176"></a>..176     {reply, Res, State}.
</span><span class="marked"><a name="line177"></a>..177 
</span><span class="marked"><a name="line178"></a>..178 handle_cast({accepted, Pid}, State = #mochiweb_socket_server{acceptor = Pid, max = Max}) ->
</span><span class="uncovered"><a name="line179"></a>..179     NewState = State#mochiweb_socket_server{max = Max - 1},
</span><span class="uncovered"><a name="line180"></a>..180     {noreply, new_acceptor(NewState)};
</span><span class="marked"><a name="line181"></a>..181 handle_cast(stop, State) ->
</span><span class="uncovered"><a name="line182"></a>..182     {stop, normal, State}.
</span><span class="marked"><a name="line183"></a>..183 
</span><span class="highlight"><a name="line184"></a>..184 %% @todo Clean up the catch fdsrv:stop/0 call.
</span><span class="marked"><a name="line185"></a>..185 terminate(_Reason, #mochiweb_socket_server{listen = Listen, port = Port}) ->
</span><span class="uncovered"><a name="line186"></a>..186     gen_tcp:close(Listen),
</span><span class="uncovered"><a name="line187"></a>..187     case Port < 1024 of 
</span><span class="marked"><a name="line188"></a>..188         true ->
</span><span class="uncovered"><a name="line189"></a>..189             catch fdsrv:stop(),
</span><span class="uncovered"><a name="line190"></a>..190             ok;
</span><span class="marked"><a name="line191"></a>..191         false ->
</span><span class="uncovered"><a name="line192"></a>..192             ok
</span><span class="marked"><a name="line193"></a>..193     end.
</span><span class="marked"><a name="line194"></a>..194 
</span><span class="marked"><a name="line195"></a>..195 code_change(_OldVsn, State, _Extra) ->
</span><span class="uncovered"><a name="line196"></a>..196     State.
</span><span class="marked"><a name="line197"></a>..197 
</span><span class="marked"><a name="line198"></a>..198 handle_info({'EXIT', Pid, normal}, State = #mochiweb_socket_server{acceptor = Pid}) ->
</span><span class="uncovered"><a name="line199"></a>..199     {noreply, new_acceptor(State)};
</span><span class="marked"><a name="line200"></a>..200 handle_info({'EXIT', Pid, Reason}, State = #mochiweb_socket_server{acceptor = Pid}) ->
</span><span class="uncovered"><a name="line201"></a>..201     error_logger:error_report({?MODULE, ?LINE, {acceptor_error, Reason}}),
</span><span class="uncovered"><a name="line202"></a>..202     timer:sleep(100),
</span><span class="uncovered"><a name="line203"></a>..203     {noreply, new_acceptor(State)};
</span><span class="marked"><a name="line204"></a>..204 handle_info({'EXIT', _LoopPid, Reason}, State=#mochiweb_socket_server{acceptor = Pid, max = Max}) ->
</span><span class="uncovered"><a name="line205"></a>..205     case Reason of
</span><span class="uncovered"><a name="line206"></a>..206         normal -> ok;
</span><span class="uncovered"><a name="line207"></a>..207         _ -> error_logger:error_report({?MODULE, ?LINE, {child_error, Reason}})
</span><span class="marked"><a name="line208"></a>..208     end,
</span><span class="uncovered"><a name="line209"></a>..209     NewState = case Pid of
</span><span class="uncovered"><a name="line210"></a>..210         null -> new_acceptor(State#mochiweb_socket_server{max = Max + 1});
</span><span class="uncovered"><a name="line211"></a>..211         _ -> State#mochiweb_socket_server{max = Max + 1}
</span><span class="marked"><a name="line212"></a>..212     end,
</span><span class="uncovered"><a name="line213"></a>..213     {noreply, NewState};
</span><span class="marked"><a name="line214"></a>..214 handle_info(Info, State) ->
</span><span class="uncovered"><a name="line215"></a>..215     error_logger:info_report([{'INFO', Info}, {'State', State}]),
</span><span class="uncovered"><a name="line216"></a>..216     {noreply, State}.
</span></pre><hr /><p>Generated using <a href='http://github.com/ngerakines/etap'>etap 0.3.3</a>.</p>
          </body>
        </html>
    